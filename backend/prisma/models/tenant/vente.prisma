enum StatutVente {
    BROUILLON
    EN_ATTENTE
    PAYEE
    ANNULEE
    REMBOURSEE
    PARTIELLEMENT_REMBOURSEE
}

enum MethodePaiement {
    ESPECES
    MOBILE_MONEY
    CARTE
    CHEQUE
    VIREMENT
    AUTRE
}

model vente {
    id                String          @id @default(uuid())
    numero_vente      String?         @unique // Format TC-YYYYMMDD-XXX
    magasin_id        String
    utilisateur_id    String
    client_id         String?
    montant_total     Float
    montant_remise    Float           @default(0)
    montant_tva       Float           @default(0)
    montant_paye      Float? // Montant effectivement payé par le client
    montant_rendu     Float? // Monnaie rendue au client
    statut            StatutVente
    methode_paiement  MethodePaiement
    notes             String?
    session_caisse_id String? // Lien vers la session de caisse (optionnel pour retrocompatibilité)
    date_creation     DateTime        @default(now())
    date_modification DateTime        @updatedAt

    magasin        magasin         @relation(fields: [magasin_id], references: [id], onDelete: Cascade)
    utilisateur    TenantUser      @relation(fields: [utilisateur_id], references: [id], onDelete: Restrict)
    client         client?         @relation(fields: [client_id], references: [id], onDelete: SetNull)
    session_caisse session_caisse? @relation(fields: [session_caisse_id], references: [id], onDelete: SetNull)
    details        vente_detail[]
    facture        facture?

    @@index([magasin_id])
    @@index([utilisateur_id])
    @@index([client_id])
    @@index([session_caisse_id])
    @@index([date_creation])
    @@map("ventes")
}

model vente_detail {
    id                  String  @id @default(uuid())
    vente_id            String
    produit_id          String
    quantite            Int
    quantite_remboursee Int     @default(0) // Quantité remboursée
    prix_unitaire       Float
    remise              Float   @default(0)
    prix_total          Float
    conditionnement_id  String?

    vente           vente                    @relation(fields: [vente_id], references: [id], onDelete: Cascade)
    produit         produit                  @relation(fields: [produit_id], references: [id], onDelete: Restrict)
    conditionnement conditionnement_produit? @relation(fields: [conditionnement_id], references: [id])

    @@map("ventes_details")
}

model facture {
    id             String    @id @default(uuid())
    vente_id       String    @unique
    numero_facture String    @unique
    montant_ht     Float
    montant_tva    Float     @default(0)
    montant_ttc    Float
    statut         String    @default("VALIDEE") // BROUILLON, VALIDEE, PAYEE, ANNULEE
    date_emission  DateTime  @default(now())
    date_echeance  DateTime?
    pdf_url        String?
    notes          String?

    vente vente @relation(fields: [vente_id], references: [id], onDelete: Cascade)

    @@index([numero_facture])
    @@map("factures")
}
